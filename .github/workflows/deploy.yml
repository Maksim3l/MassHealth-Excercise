name: Deploy

on:
  workflow_run:
    workflows: ["MQTT-Test", "Face-Verification-API-Test"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure both workflows passed
        id: check-status
        run: |
          set -e

          WORKFLOWS=("MQTT-Test" "Face-Verification-API-Test")
          for WF in "${WORKFLOWS[@]}"; do
            echo "Checking $WF..."
            RUN_STATUS=$(gh run list --workflow="$WF" --json conclusion,status -L 1 \
              | jq -r '.[0] | "\(.status):\(.conclusion)"')

            STATUS=$(echo "$RUN_STATUS" | cut -d: -f1)
            CONCLUSION=$(echo "$RUN_STATUS" | cut -d: -f2)

            if [[ "$STATUS" != "completed" || "$CONCLUSION" != "success" ]]; then
              echo "$WF not successful (status=$STATUS, conclusion=$CONCLUSION)"
              exit 1
            fi
          done

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push all services
        run: |
          docker compose -f extensions/docker-compose.yml build
          docker compose -f backend/supabase-project/docker-compose.yml build
          docker compose -f frontend/docker-compose.yml build

          declare -A SERVICE_PATHS=(
            ["extra_service"]="extensions"
            ["backend_service"]="backend/supabase-project"
            ["frontend_service"]="frontend"
          )

          for SERVICE in "${!SERVICE_PATHS[@]}"; do
            IMAGE_NAME="thecoffeeaddict/masshealth:${SERVICE}"
            echo "Tagging and pushing $SERVICE -> $IMAGE_NAME"
            docker tag "${SERVICE_PATHS[$SERVICE]}_${SERVICE}" "$IMAGE_NAME"
            docker push "$IMAGE_NAME"
          done

